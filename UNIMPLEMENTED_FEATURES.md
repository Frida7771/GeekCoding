# 未实现功能清单

## 一、已修复但需要验证的功能

### 1. ✅ 沙盒安全措施（已实现，需验证）
- ✅ CPU 限制 (`--cpus=1.0`)
- ✅ 进程数限制 (`--pids-limit=10`)
- ✅ 非 root 用户 (`--user=1000:1000`)
- ✅ 只读文件系统 (`--read-only`)
- ✅ 临时文件系统 (`--tmpfs`)
- ✅ Capabilities 删除 (`--cap-drop=ALL`)
- ✅ 资源限制 (`--ulimit`)

**状态**: 已实现，但需要测试验证

---

## 二、部分实现的功能

### 2. ✅ AC/TLE 判断的竞态条件（已修复）

**当前状态**:
- ✅ 已添加 TLE channel
- ✅ 已使用 `context.WithTimeout` 实现每个测试用例的独立超时
- ✅ 已添加明确的 AC channel
- ✅ AC 判断不再依赖全局超时

**修复内容**:
1. 添加了 `AC` channel 用于明确的 AC 信号
2. 在每个测试用例通过时，检查是否所有测试都通过，如果是则发送 AC 信号
3. 在 select 中，AC case 优先级最高，确保正确判断
4. 全局超时作为兜底机制，但不再用于判断 AC

**实现代码**:
```go
// 添加 AC channel
AC := make(chan int)
totalTests := len(pb.TestCases)

// 在每个测试用例通过时
lock.Lock()
passCount++
if passCount == totalTests {
    AC <- 1  // 明确发送 AC 信号
}
lock.Unlock()

// 在 select 中，AC 优先级最高
case <-AC:
    sb.Status = 1  // Accepted
    msg = "答案正确"
```

---

### 3. ✅ 超时控制的完善（已修复）

**当前状态**:
- ✅ 已使用 `context.WithTimeout` 实现每个测试用例的独立超时
- ✅ 已添加 TLE channel
- ✅ 已优化全局超时计算逻辑
- ✅ 已添加测试用例完成状态跟踪

**修复内容**:

1. **优化全局超时计算**:
   - **之前**: `MaxRuntime * 测试用例数量 * 2`（不准确，因为测试用例是并发执行的）
   - **现在**: `MaxRuntime + MaxRuntime/2`（考虑并发执行，只需单个超时时间 + 缓冲）
   - 更准确地反映实际执行时间

2. **添加完成状态跟踪**:
   - 添加 `completedCount` 跟踪完成的测试用例数量
   - 使用 `defer` 确保每个测试用例完成时都会更新计数器
   - 可以准确判断是否所有测试用例都已完成

3. **优化超时判断逻辑**:
   - 在全局超时触发时，检查 `completedCount` 和 `passCount`
   - 区分"所有测试用例都完成"和"还有测试用例未完成"
   - 如果所有测试用例都完成但未收到 AC 信号，正确标记为 AC
   - 如果还有测试用例未完成，标记为 TLE

4. **防止重复 TLE 信号**:
   - 使用 `select` 的 `default` 分支防止重复发送 TLE 信号
   - 只有第一个超时的测试用例会发送 TLE 信号

**实现代码**:
```go
// 跟踪完成的测试用例数量
completedCount := 0

// 在每个测试用例中
defer func() {
    lock.Lock()
    completedCount++
    lock.Unlock()
}()

// 优化后的全局超时计算
bufferTime := time.Millisecond * time.Duration(pb.MaxRuntime) / 2
globalTimeout := time.After(time.Millisecond*time.Duration(pb.MaxRuntime) + bufferTime)

// 优化后的超时判断
case <-globalTimeout:
    lock.Lock()
    if completedCount == totalTests {
        // 所有测试用例都完成了
        if passCount == totalTests {
            sb.Status = 1  // Accepted
        } else {
            sb.Status = 2  // Wrong Answer
        }
    } else {
        // 还有测试用例未完成，确实超时了
        sb.Status = 3  // Time Limit Exceeded
    }
    lock.Unlock()
```

---

## 三、完全未实现的功能

### 4. ❌ 系统调用过滤 (seccomp)

**功能**: 限制容器可以执行的系统调用

**实现方式**:
```bash
--security-opt seccomp=./seccomp-profile.json
```

**优先级**: 低（已有其他安全措施）

---

### 5. ❌ AppArmor/SELinux 配置

**功能**: 额外的安全策略

**实现方式**:
```bash
--security-opt apparmor=docker-default
```

**优先级**: 低（已有其他安全措施）

---

### 6. ❌ 资源监控和日志

**功能**: 
- 监控容器资源使用情况
- 记录详细的执行日志
- 资源使用统计

**实现方式**:
- 使用 Docker stats API
- 记录每个测试用例的资源使用
- 存储到数据库或日志文件

**优先级**: 中

---

### 7. ❌ 代码语言支持扩展

**当前**: 仅支持 Go

**未实现**:
- Python 支持
- C/C++ 支持
- Java 支持
- 其他语言支持

**优先级**: 中（取决于需求）

---

### 8. ❌ 代码模板功能

**功能**: 
- 为不同语言提供代码模板
- 用户可以选择模板开始编写

**优先级**: 低

---

### 9. ❌ 代码高亮和编辑器

**功能**: 
- 前端代码编辑器（如 Monaco Editor）
- 语法高亮
- 代码自动补全

**优先级**: 低（前端功能）

---

### 10. ❌ 实时判题结果推送

**功能**: 
- WebSocket 实时推送判题结果
- 不需要轮询查询结果

**优先级**: 中

---

### 11. ❌ 代码分享功能

**功能**: 
- 用户可以分享自己的 AC 代码
- 查看其他用户的解决方案

**优先级**: 低

---

### 12. ❌ 讨论区/评论区

**功能**: 
- 题目讨论区
- 代码评论
- 问答功能

**优先级**: 低

---

### 13. ❌ 题目难度标签

**功能**: 
- 自动或手动标记题目难度
- 按难度筛选题目

**优先级**: 低

---

### 14. ❌ 题目统计信息

**功能**: 
- 通过率统计
- 提交数统计
- 平均通过时间
- 热门题目

**优先级**: 中

---

### 15. ❌ 用户个人统计

**功能**: 
- 详细的个人统计页面
- 通过题目列表
- 提交历史图表
- 学习进度

**优先级**: 中

---

### 16. ❌ 题目收藏功能

**功能**: 
- 收藏题目
- 收藏列表
- 稍后练习

**优先级**: 低

---

### 17. ❌ 批量导入题目

**功能**: 
- 从文件批量导入题目
- 支持多种格式（JSON, CSV, Markdown）

**优先级**: 低

---

### 18. ❌ 题目版本控制

**功能**: 
- 题目修改历史
- 版本回滚
- 变更记录

**优先级**: 低

---

### 19. ❌ 测试用例管理优化

**功能**: 
- 测试用例的增删改查
- 测试用例的批量导入
- 测试用例的验证

**优先级**: 低（已有基本功能）

---

### 20. ❌ 管理员仪表板

**功能**: 
- 系统统计概览
- 用户管理界面
- 题目管理界面
- 系统监控

**优先级**: 中

---

### 21. ❌ 邮件通知

**功能**: 
- 判题结果邮件通知
- 系统公告邮件
- 活动通知

**优先级**: 低

---

### 22. ❌ 文件上传功能

**功能**: 
- 支持上传代码文件
- 支持上传测试用例文件
- 文件管理

**优先级**: 低

---

### 23. ❌ API 限流

**功能**: 
- 防止 API 滥用
- 用户级别的限流
- IP 级别的限流

**优先级**: 高（生产环境必需）

---

### 24. ❌ 日志系统

**功能**: 
- 结构化日志
- 日志轮转
- 日志查询和分析

**优先级**: 中

---

### 25. ❌ 错误追踪

**功能**: 
- 错误日志收集
- 错误分析
- 错误报告

**优先级**: 中

---

### 26. ❌ 性能监控

**功能**: 
- 系统性能监控
- 数据库性能监控
- API 响应时间监控

**优先级**: 中

---

### 27. ❌ 备份和恢复

**功能**: 
- 数据库自动备份
- 数据恢复功能
- 备份策略

**优先级**: 高（生产环境必需）

---

### 28. ❌ 多环境配置

**功能**: 
- 开发/测试/生产环境配置
- 环境变量管理
- 配置中心

**优先级**: 中

---

### 29. ❌ Docker 镜像自动清理

**功能**: 
- 自动清理临时文件
- 清理旧的 Docker 容器
- 清理未使用的镜像

**优先级**: 中

---

### 30. ❌ 容器资源使用统计

**功能**: 
- 记录每个提交的资源使用情况
- 内存使用统计
- CPU 使用统计
- 执行时间统计

**优先级**: 低

---

## 四、需要优化的功能

### 31. ⚠️ 数据库查询优化

**当前**: 基本查询实现

**需要优化**:
- 添加数据库索引
- 优化复杂查询
- 查询结果缓存
- 分页优化

**优先级**: 中

---

### 32. ⚠️ 并发控制优化

**当前**: 基本的 goroutine 并发

**需要优化**:
- 并发数限制
- 任务队列
- 优先级队列
- 负载均衡

**优先级**: 中

---

### 33. ⚠️ 错误处理完善

**当前**: 基本错误处理

**需要优化**:
- 统一的错误处理
- 错误码定义
- 错误信息国际化
- 错误恢复机制

**优先级**: 中

---

### 34. ⚠️ 输入验证

**当前**: 基本验证

**需要优化**:
- 更严格的输入验证
- SQL 注入防护
- XSS 防护
- 参数校验

**优先级**: 高

---

### 35. ⚠️ 测试覆盖

**当前**: 可能有部分测试

**需要添加**:
- 单元测试
- 集成测试
- 端到端测试
- 性能测试

**优先级**: 中

---

## 五、安全相关

### 36. ❌ HTTPS 支持

**功能**: 
- SSL/TLS 证书配置
- 强制 HTTPS

**优先级**: 高（生产环境必需）

---

### 37. ❌ 密码强度要求

**功能**: 
- 密码复杂度验证
- 密码强度检查

**优先级**: 中

---

### 38. ❌ 双因素认证 (2FA)

**功能**: 
- TOTP 支持
- 短信验证码登录

**优先级**: 低

---

### 39. ❌ 登录日志

**功能**: 
- 记录登录历史
- 异常登录检测
- IP 地址记录

**优先级**: 中

---

### 40. ❌ 会话管理

**功能**: 
- 会话超时
- 多设备登录管理
- 强制下线

**优先级**: 中

---

## 总结

### 高优先级（生产环境必需）
1. ✅ 沙盒安全措施（已实现，需验证）
2. ⚠️ AC/TLE 竞态条件修复（部分修复）
3. ❌ API 限流
4. ❌ 备份和恢复
5. ❌ HTTPS 支持
6. ⚠️ 输入验证完善

### 中优先级（重要功能）
1. ⚠️ 超时控制完善
2. ❌ 资源监控和日志
3. ❌ 代码语言支持扩展
4. ❌ 实时判题结果推送
5. ❌ 题目统计信息
6. ❌ 用户个人统计
7. ❌ 管理员仪表板
8. ❌ 日志系统
9. ❌ 错误追踪
10. ❌ 性能监控

### 低优先级（可选功能）
1. ❌ 系统调用过滤
2. ❌ AppArmor/SELinux
3. ❌ 代码模板
4. ❌ 代码分享
5. ❌ 讨论区
6. ❌ 题目收藏
7. ❌ 批量导入
8. ❌ 其他增强功能

---

## 建议的下一步

1. **立即修复**: AC/TLE 竞态条件
2. **验证测试**: 沙盒安全措施
3. **生产准备**: API 限流、HTTPS、备份
4. **功能增强**: 根据用户需求逐步添加

